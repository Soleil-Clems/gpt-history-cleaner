chrome.runtime.onMessage.addListener((t,s,e)=>{if(t.type==="GPT_HISTORY_ACTION")return h(t.action,t.id,s.tab?.id||null).then(()=>e({success:!0})).catch(r=>{console.error("[GPT History Cleaner] Error:",r),e({success:!1,error:r.message})}),!0});async function h(t,s,e){if(!e){const o=await chrome.tabs.query({active:!0,currentWindow:!0});if(!o||!o[0])throw new Error("No active tab found");e=o[0].id}const r=await chrome.scripting.executeScript({target:{tabId:e},world:"MAIN",func:f,args:[t,s]});if(r?.[0]?.result?.success)return r[0].result;throw new Error(r?.[0]?.result?.error||"Action failed")}async function f(t,s){try{const e=a=>{const i=`; ${document.cookie}`.split(`; ${a}=`);return i.length===2?i.pop().split(";").shift():null},r=()=>e("oai-did")||localStorage.getItem("oai-did")||"5c97cf74-5c28-412c-91f9-66c10f5aedb4",o=await fetch("https://chatgpt.com/api/auth/session");if(!o.ok)throw new Error("Failed to fetch session");const c=(await o.json())?.accessToken,u=r();if(!c)throw new Error("No authentication token found. Please refresh the page.");const l=t==="delete"?{is_visible:!1}:{is_archived:!0},n=await fetch(`https://chatgpt.com/backend-api/conversation/${s}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`,"oai-device-id":u,"oai-language":navigator.language||"en-US"},body:JSON.stringify(l),credentials:"include"});if(!n.ok){const a=await n.text();throw new Error(`HTTP ${n.status}: ${a}`)}const d=await n.json();return{success:!0,status:n.status,data:d}}catch(e){return console.error(`[GPT History Cleaner] ${t} failed:`,e),{success:!1,error:e.message}}}
