chrome.runtime.onMessage.addListener((s,u,r)=>{if(s.type==="GPT_HISTORY_ACTION")return chrome.tabs.query({active:!0,currentWindow:!0},e=>{if(!e||!e[0]){console.error("[GPT History Cleaner] No active tab found"),r({success:!1,error:"No active tab found"});return}const t=e[0].id;y(s.action,s.id,t).then(()=>r({success:!0})).catch(n=>{console.error("[GPT History Cleaner] Error:",n),r({success:!1,error:n.message})})}),!0});async function y(s,u,r){if(!r)throw new Error("No tab ID available");const e=await chrome.scripting.executeScript({target:{tabId:r},world:"MAIN",func:async(t,n)=>{try{let a=function(o){const d=`; ${document.cookie}`.split(`; ${o}=`);return d.length===2?d.pop().split(";").shift():null};var T=a;const h=()=>a("oai-did")||localStorage.getItem("oai-did")||"5c97cf74-5c28-412c-91f9-66c10f5aedb4",l=await(async()=>{try{return(await(await fetch("https://chatgpt.com/api/auth/session")).json())?.accessToken||null}catch(o){return console.error("[GPT History Cleaner] Failed to get session:",o),null}})();if(!l)throw new Error("No authentication token found. Please refresh the page and try again.");const f=`https://chatgpt.com/backend-api/conversation/${n}`;let i;t==="delete"?i={is_visible:!1}:t==="archive"&&(i={is_archived:!0});const g={"Content-Type":"application/json",Authorization:`Bearer ${l}`,"oai-device-id":h(),"oai-language":navigator.language||"en-US"},c=await fetch(f,{method:"PATCH",headers:g,body:JSON.stringify(i),credentials:"include"});if(!c.ok){const o=await c.text();throw new Error(`HTTP ${c.status}: ${o}`)}const w=await c.json();return console.log(`[GPT History Cleaner] ${t} success:`,n),{success:!0,status:c.status,data:w}}catch(a){throw console.error(`[GPT History Cleaner] ${t} failed:`,a),a}},args:[s,u]});if(e&&e[0]&&e[0].result){if(e[0].result.success)return e[0].result;throw new Error(e[0].result.error||"Unknown error")}throw new Error("No result returned from script execution")}
