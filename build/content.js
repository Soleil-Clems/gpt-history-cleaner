let e={convList:[],selectedNum:0,isInjected:!1,extensionUI:null,toggleChecked:!1,checkAll:!1};window.addEventListener("load",()=>{S()});function S(){new MutationObserver(()=>{const s=document.querySelector("nav aside"),c=document.querySelector("#history");!c||!s||((!e.isInjected||!document.body.contains(e.extensionUI))&&q(s,c),e.toggleChecked&&P(c))}).observe(document.body,{childList:!0,subtree:!0})}function q(i,s){if(e.extensionUI&&document.body.contains(e.extensionUI))return;const c=document.createElement("div"),l=document.createElement("div");c.setAttribute("tabindex","0");const r=document.createElement("img");r.src=chrome.runtime.getURL("logo.png"),r.style.width="20px",r.style.height="20px";const b=document.createTextNode("GPT history cleaner"),a=document.createElement("input");a.type="checkbox",a.name="toggle",a.style.marginRight="8px",l.appendChild(r),l.appendChild(b),l.appendChild(a),l.className="flex gap-2 items-center",c.className="group hoverable flex gap-2 flex-col items-center justify-around",c.appendChild(l);const f=document.createElement("div");f.className="hidden flex-col h-full text-sm";const h=document.createElement("div");h.className="flex items-center gap-2 p-1",h.style.display="none";const m=document.createElement("input");m.type="checkbox",m.name="select_all";const k=document.createTextNode("Select All");h.appendChild(m),h.appendChild(k);const y=document.createElement("div");y.className="flex gap-2 justify-around p-1 h-[50px]";const p=document.createElement("p");p.className="text-xs text-gray-500";const x=document.createElement("button"),g=document.createElement("button");x.className="flex text-center items-center p-2 h-6 text-sm bg-yellow-500 text-black rounded-md hover:bg-yellow-400",g.className="flex text-center items-center p-2 h-6 text-sm bg-red-500 text-white rounded-md hover:bg-red-600";const N=document.createTextNode(e.selectedNum+" conversation(s) selected"),w=document.createTextNode("Archive"),A=document.createTextNode("Delete");p.appendChild(N),x.appendChild(w),g.appendChild(A),y.appendChild(x),y.appendChild(g),f.appendChild(h),f.appendChild(p),f.appendChild(y),c.appendChild(f),i.before(c),e.extensionUI=c,e.isInjected=!0,g.addEventListener("click",async()=>{if(e.convList.length===0)return;const o=e.convList.filter(t=>t&&typeof t=="string"&&!t.includes("Promise"));if(o.length===0)return;g.disabled=!0;const n=g.textContent;g.textContent="Deleting...";try{let t=0,u=0;for(const d of o)try{await E("delete",d),t++,await new Promise(v=>setTimeout(v,200))}catch(v){console.error(`Failed to delete ${d}:`,v),u++}e.convList=[],e.selectedNum=0,p.textContent="0 conversation(s) selected"}catch(t){console.error("Delete operation failed:",t),alert("Operation failed. Check console for details.")}finally{g.disabled=!1,g.textContent=n,window.location.reload()}}),x.addEventListener("click",async()=>{if(e.convList.length===0)return;const o=e.convList.filter(t=>t&&typeof t=="string"&&!t.includes("Promise"));if(o.length===0)return;x.disabled=!0;const n=x.textContent;x.textContent="Archiving...";try{let t=0,u=0;for(const d of o)try{await E("archive",d),t++,await new Promise(v=>setTimeout(v,200))}catch(v){console.error(`Failed to archive ${d}:`,v),u++}e.convList=[],e.selectedNum=0,p.textContent="0 conversation(s) selected",location.reload()}catch(t){console.error("Archive operation failed:",t),alert("Operation failed. Check console for details.")}finally{x.disabled=!1,x.textContent=n}}),a.addEventListener("change",()=>{const o=s.querySelectorAll("nav a");e.toggleChecked=a.checked,a.checked?(h.style.display="flex",f.classList.remove("hidden"),f.classList.add("flex"),o.forEach(n=>{T(n)})):(h.style.display="none",m.checked=!1,e.checkAll=!1,o.forEach(n=>{I(n)}),e.convList=[],e.selectedNum=0,p.textContent="0 conversation(s) selected",f.classList.remove("flex"),f.classList.add("hidden"))}),m.addEventListener("change",()=>{if(!e.toggleChecked)return;e.checkAll=m.checked;const o=s.querySelectorAll("nav a");m.checked?(e.convList=[],o.forEach(n=>{const t=n.querySelector("input[type='checkbox']");if(t){t.checked=!0;const u=n.getAttribute("href"),d=C(u);d&&!e.convList.includes(d)&&e.convList.push(d)}})):(e.convList=[],o.forEach(n=>{const t=n.querySelector("input[type='checkbox']");t&&(t.checked=!1)})),e.selectedNum=e.convList.length,p.textContent=e.selectedNum+" conversation(s) selected",console.log("Select All:",m.checked,"Valid IDs:",e.convList)});function L(o){if(!e.toggleChecked)return;o.preventDefault();const n=o.currentTarget,t=n.querySelector("input[type='checkbox']");if(!t)return;t.checked=!t.checked;const u=n.getAttribute("href"),d=C(u);if(d){if(t.checked)e.convList.includes(d)||e.convList.push(d);else{const v=e.convList.indexOf(d);v>-1&&e.convList.splice(v,1)}console.log("Selected conversations:",e.convList),e.selectedNum=e.convList.length,p.textContent=e.selectedNum+" conversation(s) selected"}}function T(o){if(o.querySelector("input[type='checkbox']"))return;const n=document.createElement("input");n.type="checkbox",n.name="conv",n.style.marginRight="8px",n.style.pointerEvents="none";const t=o.getAttribute("href"),u=C(t);e.checkAll&&u?(n.checked=!0,e.convList.includes(u)||e.convList.push(u)):u&&e.convList.includes(u)&&(n.checked=!0),o.prepend(n),o.addEventListener("click",L)}function I(o){const n=o.querySelector("input[type='checkbox']");n&&o.removeChild(n),o.removeEventListener("click",L)}}function P(i){const s=i.querySelectorAll("nav a"),c=document.querySelector("p.text-xs.text-gray-500");s.forEach(l=>{if(!l.querySelector("input[type='checkbox']")){const r=document.createElement("input");r.type="checkbox",r.name="conv",r.style.marginRight="8px";const b=l.getAttribute("href"),a=C(b);e.checkAll&&a?(r.checked=!0,e.convList.includes(a)||(e.convList.push(a),e.selectedNum=e.convList.length,c&&(c.textContent=e.selectedNum+" conversation(s) selected"))):a&&e.convList.includes(a)&&(r.checked=!0),l.prepend(r),l.addEventListener("click",f=>{if(!e.toggleChecked)return;f.preventDefault();const h=l.querySelector("input[type='checkbox']");if(!h)return;h.checked=!h.checked;const m=l.getAttribute("href"),k=C(m);if(!k)return;if(h.checked)e.convList.includes(k)||e.convList.push(k);else{const p=e.convList.indexOf(k);p>-1&&e.convList.splice(p,1)}console.log("Selected conversations:",e.convList),e.selectedNum=e.convList.length;const y=document.querySelector("p.text-xs.text-gray-500");y&&(y.textContent=e.selectedNum+" conversation(s) selected")})}})}function C(i){if(!i||typeof i!="string")return console.warn("[GPT History Cleaner] Invalid URL type:",typeof i,i),null;const s=i.split("/"),c=s[s.length-1];return!c||c===""||c.includes("[object")||c.includes("Promise")||c==="undefined"||c==="null"?(console.warn("[GPT History Cleaner] Invalid conversation ID extracted:",c,"from URL:",i),null):c}function E(i,s){return console.log(`[GPT History Cleaner] customFetch called with action=${i}, id=${s} (type: ${typeof s})`),!s||typeof s!="string"?Promise.reject(new Error(`Invalid ID: ${s} (type: ${typeof s})`)):new Promise((c,l)=>{chrome.runtime.sendMessage({type:"GPT_HISTORY_ACTION",action:i,id:s},r=>{if(chrome.runtime.lastError){console.error("Extension error:",chrome.runtime.lastError),l(chrome.runtime.lastError);return}r&&r.success?(console.log(`${i} success for ${s}`),c()):(console.error(`${i} failed:`,r?r.error:"No response"),l(new Error(r?r.error:"Unknown error")))})})}
