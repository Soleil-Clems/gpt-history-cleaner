let e={convList:[],selectedNum:0,isInjected:!1,extensionUI:null,toggleChecked:!1,checkAll:!1};window.addEventListener("load",()=>{$()});function $(){new MutationObserver(()=>{const r=document.querySelector("nav aside"),c=document.querySelector("#history");!c||!r||((!e.isInjected||!document.body.contains(e.extensionUI))&&q(r,c),e.toggleChecked&&P(c))}).observe(document.body,{childList:!0,subtree:!0})}function q(i,r){if(e.extensionUI&&document.body.contains(e.extensionUI))return;const c=document.createElement("div"),a=document.createElement("div");c.setAttribute("tabindex","0");const s=document.createElement("img");s.src=chrome.runtime.getURL("logo.png"),s.style.width="20px",s.style.height="20px";const L=document.createTextNode("GPT history cleaner"),u=document.createElement("input");u.type="checkbox",u.style.marginRight="8px",a.appendChild(s),a.appendChild(L),a.appendChild(u),a.className="flex gap-2 items-center",c.className="group hoverable flex gap-2 flex-col items-center justify-around",c.appendChild(a);const g=document.createElement("div");g.className="flex flex-col h-full text-sm";const h=document.createElement("div");h.className="flex items-center gap-2 p-1",h.style.display="none";const m=document.createElement("input");m.type="checkbox";const C=document.createTextNode("Select All");h.appendChild(m),h.appendChild(C);const y=document.createElement("div");y.className="flex gap-2 justify-around p-1 h-[50px]";const f=document.createElement("p");f.className="text-xs text-gray-500";const p=document.createElement("button"),v=document.createElement("button");p.className="flex text-center items-center p-2 h-6 text-sm bg-yellow-500 text-black rounded-md hover:bg-yellow-400",v.className="flex text-center items-center p-2 h-6 text-sm bg-red-500 text-white rounded-md hover:bg-red-600";const A=document.createTextNode(e.selectedNum+" conversation(s) selected"),T=document.createTextNode("Archive"),w=document.createTextNode("Delete");f.appendChild(A),p.appendChild(T),v.appendChild(w),y.appendChild(p),y.appendChild(v),g.appendChild(h),g.appendChild(f),g.appendChild(y),c.appendChild(g),i.before(c),e.extensionUI=c,e.isInjected=!0,console.log("Extension UI injected"),v.addEventListener("click",async()=>{if(e.convList.length===0){alert("No conversations selected!");return}const n=e.convList.filter(t=>t&&typeof t=="string"&&!t.includes("Promise"));if(n.length===0){alert("No valid conversations selected!");return}if(!confirm(`Delete ${n.length} conversation(s)? This cannot be undone.`))return;v.disabled=!0;const l=v.textContent;v.textContent="Deleting...";try{let t=0,d=0;for(const x of n)try{await N("delete",x),t++,await new Promise(k=>setTimeout(k,200))}catch(k){console.error(`Failed to delete ${x}:`,k),d++}alert(`✓ ${t} deleted${d>0?`, ${d} failed`:""}`),e.convList=[],e.selectedNum=0,f.textContent="0 conversation(s) selected"}catch(t){console.error("Delete operation failed:",t),alert("Operation failed. Check console for details.")}finally{v.disabled=!1,v.textContent=l}}),p.addEventListener("click",async()=>{if(e.convList.length===0){alert("No conversations selected!");return}const n=e.convList.filter(t=>t&&typeof t=="string"&&!t.includes("Promise"));if(n.length===0){alert("No valid conversations selected!");return}if(!confirm(`Archive ${n.length} conversation(s)?`))return;p.disabled=!0;const l=p.textContent;p.textContent="Archiving...";try{let t=0,d=0;for(const x of n)try{await N("archive",x),t++,await new Promise(k=>setTimeout(k,200))}catch(k){console.error(`Failed to archive ${x}:`,k),d++}alert(`✓ ${t} archived${d>0?`, ${d} failed`:""}`),e.convList=[],e.selectedNum=0,f.textContent="0 conversation(s) selected",location.reload()}catch(t){console.error("Archive operation failed:",t),alert("Operation failed. Check console for details.")}finally{p.disabled=!1,p.textContent=l}}),u.addEventListener("change",()=>{const n=r.querySelectorAll("nav a");e.toggleChecked=u.checked,u.checked?(h.style.display="flex",n.forEach(o=>{I(o)})):(h.style.display="none",m.checked=!1,e.checkAll=!1,n.forEach(o=>{S(o)}),e.convList=[],e.selectedNum=0,f.textContent="0 conversation(s) selected")}),m.addEventListener("change",()=>{if(!e.toggleChecked)return;e.checkAll=m.checked;const n=r.querySelectorAll("nav a");m.checked?(e.convList=[],n.forEach(o=>{const l=o.querySelector("input[type='checkbox']");if(l){l.checked=!0;const t=o.getAttribute("href"),d=b(t);d&&!e.convList.includes(d)&&e.convList.push(d)}})):(e.convList=[],n.forEach(o=>{const l=o.querySelector("input[type='checkbox']");l&&(l.checked=!1)})),e.selectedNum=e.convList.length,f.textContent=e.selectedNum+" conversation(s) selected",console.log("Select All:",m.checked,"Valid IDs:",e.convList)});function E(n){if(!e.toggleChecked)return;n.preventDefault();const o=n.currentTarget,l=o.querySelector("input[type='checkbox']");if(!l)return;l.checked=!l.checked;const t=o.getAttribute("href"),d=b(t);if(d){if(l.checked)e.convList.includes(d)||e.convList.push(d);else{const x=e.convList.indexOf(d);x>-1&&e.convList.splice(x,1)}console.log("Selected conversations:",e.convList),e.selectedNum=e.convList.length,f.textContent=e.selectedNum+" conversation(s) selected"}}function I(n){if(n.querySelector("input[type='checkbox']"))return;const o=document.createElement("input");o.type="checkbox",o.style.marginRight="8px";const l=n.getAttribute("href"),t=b(l);e.checkAll&&t?(o.checked=!0,e.convList.includes(t)||e.convList.push(t)):t&&e.convList.includes(t)&&(o.checked=!0),n.prepend(o),n.addEventListener("click",E)}function S(n){const o=n.querySelector("input[type='checkbox']");o&&n.removeChild(o),n.removeEventListener("click",E)}}function P(i){const r=i.querySelectorAll("nav a"),c=document.querySelector("p.text-xs.text-gray-500");r.forEach(a=>{if(!a.querySelector("input[type='checkbox']")){const s=document.createElement("input");s.type="checkbox",s.style.marginRight="8px";const L=a.getAttribute("href"),u=b(L);e.checkAll&&u?(s.checked=!0,e.convList.includes(u)||(e.convList.push(u),e.selectedNum=e.convList.length,c&&(c.textContent=e.selectedNum+" conversation(s) selected"))):u&&e.convList.includes(u)&&(s.checked=!0),a.prepend(s),a.addEventListener("click",g=>{if(!e.toggleChecked)return;g.preventDefault();const h=a.querySelector("input[type='checkbox']");if(!h)return;h.checked=!h.checked;const m=a.getAttribute("href"),C=b(m);if(!C)return;if(h.checked)e.convList.includes(C)||e.convList.push(C);else{const f=e.convList.indexOf(C);f>-1&&e.convList.splice(f,1)}console.log("Selected conversations:",e.convList),e.selectedNum=e.convList.length;const y=document.querySelector("p.text-xs.text-gray-500");y&&(y.textContent=e.selectedNum+" conversation(s) selected")})}})}function b(i){if(!i||typeof i!="string")return console.warn("[GPT History Cleaner] Invalid URL type:",typeof i,i),null;const r=i.split("/"),c=r[r.length-1];return!c||c===""||c.includes("[object")||c.includes("Promise")||c==="undefined"||c==="null"?(console.warn("[GPT History Cleaner] Invalid conversation ID extracted:",c,"from URL:",i),null):c}function N(i,r){return console.log(`[GPT History Cleaner] customFetch called with action=${i}, id=${r} (type: ${typeof r})`),!r||typeof r!="string"?Promise.reject(new Error(`Invalid ID: ${r} (type: ${typeof r})`)):new Promise((c,a)=>{chrome.runtime.sendMessage({type:"GPT_HISTORY_ACTION",action:i,id:r},s=>{if(chrome.runtime.lastError){console.error("Extension error:",chrome.runtime.lastError),a(chrome.runtime.lastError);return}s&&s.success?(console.log(`${i} success for ${r}`),c()):(console.error(`${i} failed:`,s?s.error:"No response"),a(new Error(s?s.error:"Unknown error")))})})}
