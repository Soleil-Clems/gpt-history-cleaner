let e={convList:[],selectedNum:0,isInjected:!1,extensionUI:null,toggleChecked:!1,checkAll:!1};window.addEventListener("load",()=>{U()});function U(){new MutationObserver(()=>{const s=document.querySelector("nav a[data-testid='create-new-chat-button']"),c=document.querySelector("#history");!c||!s||((!e.isInjected||!document.body.contains(e.extensionUI))&&$(s,c),e.toggleChecked&&O(c))}).observe(document.body,{childList:!0,subtree:!0})}function $(l,s){if(e.extensionUI&&document.body.contains(e.extensionUI))return;const c=document.createElement("div"),i=document.createElement("div");c.setAttribute("tabindex","0");const r=document.createElement("img");r.src=chrome.runtime.getURL("logo.png"),r.className="w-full h-full";const g=document.createElement("a");g.href="https://soleil-ouisol.fr/",g.alt="owner: Soleil OUISOL",g.target="_blank",g.className="w-8 h-8 rounded-full overflow-hidden object-cover cursor-pointer";const k=document.createTextNode("GPT history cleaner"),f=document.createElement("input"),p=document.createElement("label"),h=document.createElement("span"),C=document.createElement("span");h.appendChild(C),f.type="checkbox",f.name="toggle",f.style.marginRight="8px",g.appendChild(r),i.appendChild(g),i.appendChild(k),p.appendChild(f),p.appendChild(h),i.appendChild(p),p.className="relative inline-block w-10 h-5",f.className="peer absolute opacity-0 w-0 h-0",C.className="absolute left-1  bottom-0.5 h-4 w-4 rounded-full bg-white   transition-transform duration-300 pointer-events-none",h.className="absolute inset-0 p-1 flex items-center justify-start cursor-pointer rounded-full bg-gray-300 transition-colors duration-300 ",i.className="flex gap-2 items-center",c.className="group hoverable flex gap-2 flex-col items-center justify-around py-2",c.appendChild(i);const d=document.createElement("div");d.className="hidden flex-col h-full text-sm";const m=document.createElement("div");m.className="flex items-center gap-2 p-1",m.style.display="none";const y=document.createElement("input");y.type="checkbox",y.name="select_all";const I=document.createTextNode("Select All");m.appendChild(y),m.appendChild(I);const N=document.createElement("div");N.className="flex gap-2 justify-around p-1 h-[50px]";const b=document.createElement("p");b.className="text-xs text-gray-500";const v=document.createElement("button"),x=document.createElement("button");v.className="flex text-center items-center p-2 h-6 text-sm bg-yellow-500 text-black rounded-md hover:bg-yellow-400",x.className="flex text-center items-center p-2 h-6 text-sm bg-red-500 text-white rounded-md hover:bg-red-600";const S=document.createTextNode(e.selectedNum+" conversation(s) selected"),T=document.createTextNode("Archive"),q=document.createTextNode("Delete");b.appendChild(S),v.appendChild(T),x.appendChild(q),N.appendChild(v),N.appendChild(x),d.appendChild(m),d.appendChild(b),d.appendChild(N),c.appendChild(d),l.before(c),e.extensionUI=c,e.isInjected=!0,x.addEventListener("click",async()=>{if(e.convList.length===0)return;const o=e.convList.filter(t=>t&&typeof t=="string"&&!t.includes("Promise"));if(o.length===0)return;x.disabled=!0;const n=x.textContent;x.textContent="Deleting...";try{let t=0,u=0;for(const a of o)try{await A("delete",a),t++}catch(L){console.error(`Failed to delete ${a}:`,L),u++}e.convList=[],e.selectedNum=0,b.textContent="0 conversation(s) selected"}catch(t){console.error("Delete operation failed:",t),alert("Operation failed. Check console for details.")}finally{x.disabled=!1,x.textContent=n,window.location.reload()}}),v.addEventListener("click",async()=>{if(e.convList.length===0)return;const o=e.convList.filter(t=>t&&typeof t=="string"&&!t.includes("Promise"));if(o.length===0)return;v.disabled=!0;const n=v.textContent;v.textContent="Archiving...";try{let t=0,u=0;for(const a of o)try{await A("archive",a),t++}catch(L){console.error(`Failed to archive ${a}:`,L),u++}e.convList=[],e.selectedNum=0,b.textContent="0 conversation(s) selected",location.reload()}catch(t){console.error("Archive operation failed:",t),alert("Operation failed. Check console for details.")}finally{v.disabled=!1,v.textContent=n}}),f.addEventListener("change",()=>{const o=s.querySelectorAll("nav a");e.toggleChecked=f.checked,f.checked?(m.style.display="flex",d.classList.remove("hidden"),h.classList.remove("bg-gray-300"),h.classList.remove("justify-start"),h.classList.add("bg-blue-500"),h.classList.add("justify-end"),d.classList.add("flex"),o.forEach(n=>{j(n)})):(m.style.display="none",y.checked=!1,e.checkAll=!1,d.classList.remove("flex"),d.classList.add("hidden"),h.classList.remove("justify-end"),d.classList.add("justify-start"),h.classList.add("bg-gray-300"),h.classList.remove("bg-blue-500")),o.forEach(n=>{P(n)}),e.convList=[],e.selectedNum=0,b.textContent="0 conversation(s) selected"}),y.addEventListener("change",()=>{if(!e.toggleChecked)return;e.checkAll=y.checked;const o=s.querySelectorAll("nav a");y.checked?(e.convList=[],o.forEach(n=>{const t=n.querySelector("input[type='checkbox']");if(t){t.checked=!0;const u=n.getAttribute("href"),a=E(u);a&&!e.convList.includes(a)&&e.convList.push(a)}})):(e.convList=[],o.forEach(n=>{const t=n.querySelector("input[type='checkbox']");t&&(t.checked=!1)})),e.selectedNum=e.convList.length,b.textContent=e.selectedNum+" conversation(s) selected",console.log("Select All:",y.checked,"Valid IDs:",e.convList)});function w(o){if(!e.toggleChecked)return;o.preventDefault();const n=o.currentTarget,t=n.querySelector("input[type='checkbox']");if(!t)return;t.checked=!t.checked;const u=n.getAttribute("href"),a=E(u);if(a){if(t.checked)e.convList.includes(a)||e.convList.push(a);else{const L=e.convList.indexOf(a);L>-1&&e.convList.splice(L,1)}console.log("Selected conversations:",e.convList),e.selectedNum=e.convList.length,b.textContent=e.selectedNum+" conversation(s) selected"}}function j(o){if(o.querySelector("input[type='checkbox']"))return;const n=document.createElement("input");n.type="checkbox",n.name="conv",n.style.marginRight="8px",n.style.pointerEvents="none";const t=o.getAttribute("href"),u=E(t);e.checkAll&&u?(n.checked=!0,e.convList.includes(u)||e.convList.push(u)):u&&e.convList.includes(u)&&(n.checked=!0),o.prepend(n),o.addEventListener("click",w)}function P(o){const n=o.querySelector("input[type='checkbox']");n&&o.removeChild(n),o.removeEventListener("click",w)}}function O(l){const s=l.querySelectorAll("nav a"),c=document.querySelector("p.text-xs.text-gray-500");s.forEach(i=>{if(!i.querySelector("input[type='checkbox']")){const r=document.createElement("input");r.type="checkbox",r.name="conv",r.style.marginRight="8px";const g=i.getAttribute("href"),k=E(g);e.checkAll&&k?(r.checked=!0,e.convList.includes(k)||(e.convList.push(k),e.selectedNum=e.convList.length,c&&(c.textContent=e.selectedNum+" conversation(s) selected"))):k&&e.convList.includes(k)&&(r.checked=!0),i.prepend(r),i.addEventListener("click",f=>{if(!e.toggleChecked)return;f.preventDefault();const p=i.querySelector("input[type='checkbox']");if(!p)return;p.checked=!p.checked;const h=i.getAttribute("href"),C=E(h);if(!C)return;if(p.checked)e.convList.includes(C)||e.convList.push(C);else{const m=e.convList.indexOf(C);m>-1&&e.convList.splice(m,1)}console.log("Selected conversations:",e.convList),e.selectedNum=e.convList.length;const d=document.querySelector("p.text-xs.text-gray-500");d&&(d.textContent=e.selectedNum+" conversation(s) selected")})}})}function E(l){if(!l||typeof l!="string")return console.warn("[GPT History Cleaner] Invalid URL type:",typeof l,l),null;const s=l.split("/"),c=s[s.length-1];return!c||c===""||c.includes("[object")||c.includes("Promise")||c==="undefined"||c==="null"?(console.warn("[GPT History Cleaner] Invalid conversation ID extracted:",c,"from URL:",l),null):c}function A(l,s){return console.log(`[GPT History Cleaner] customFetch called with action=${l}, id=${s} (type: ${typeof s})`),!s||typeof s!="string"?Promise.reject(new Error(`Invalid ID: ${s} (type: ${typeof s})`)):new Promise((c,i)=>{chrome.runtime.sendMessage({type:"GPT_HISTORY_ACTION",action:l,id:s},r=>{if(chrome.runtime.lastError){console.error("Extension error:",chrome.runtime.lastError),i(chrome.runtime.lastError);return}r&&r.success?(console.log(`${l} success for ${s}`),c()):(console.error(`${l} failed:`,r?r.error:"No response"),i(new Error(r?r.error:"Unknown error")))})})}
