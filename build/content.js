let e={convList:[],selectedNum:0,isInjected:!1,extensionUI:null,toggleChecked:!1,checkAll:!1};window.addEventListener("load",()=>{O()});function O(){new MutationObserver(()=>{const l=document.querySelector("nav a[data-testid='create-new-chat-button']"),c=document.querySelector("#history");!c||!l||((!e.isInjected||!document.body.contains(e.extensionUI))&&D(l,c),e.toggleChecked&&R(c))}).observe(document.body,{childList:!0,subtree:!0})}function D(u,l){if(e.extensionUI&&document.body.contains(e.extensionUI))return;const c=document.createElement("div"),i=document.createElement("div");c.setAttribute("tabindex","0");const r=document.createElement("img");r.src=chrome.runtime.getURL("logo.png"),r.className="w-full h-full";const b=document.createElement("a");b.href="https://soleil-ouisol.fr/",b.alt="owner: Soleil OUISOL",b.target="_blank",b.className="w-8 h-8 rounded-full overflow-hidden object-cover cursor-pointer";const k=document.createTextNode("GPT history cleaner"),p=document.createElement("input"),g=document.createElement("label"),d=document.createElement("span"),C=document.createElement("span");d.appendChild(C),p.type="checkbox",p.name="toggle",p.style.marginRight="8px",b.appendChild(r),i.appendChild(b),i.appendChild(k),g.appendChild(p),g.appendChild(d),i.appendChild(g),g.className="relative inline-block w-10 h-5",p.className="peer absolute opacity-0 w-0 h-0",C.className="absolute left-1  bottom-0.5 h-4 w-4 rounded-full bg-white   transition-transform duration-300 pointer-events-none",d.className="absolute inset-0 p-1 flex items-center justify-start cursor-pointer rounded-full bg-gray-300 transition-colors duration-300 ",i.className="flex gap-2 items-center",c.className="group hoverable flex gap-2 flex-col items-center justify-around py-2",c.appendChild(i);const a=document.createElement("div");a.className="hidden flex-col h-full text-sm";const v=document.createElement("div");v.className="flex items-center gap-2 p-1",v.style.display="none";const L=document.createElement("input");L.type="checkbox",L.name="select_all";const T=document.createTextNode("Select All");v.appendChild(L),v.appendChild(T);const w=document.createElement("div");w.className="flex gap-2 justify-around p-1 h-[50px]";const y=document.createElement("p");y.className="text-xs text-gray-500";const h=document.createElement("button"),f=document.createElement("button");h.className="flex text-center items-center p-2 h-6 text-sm bg-yellow-500 text-black rounded-md hover:bg-yellow-400",f.className="flex text-center items-center p-2 h-6 text-sm bg-red-500 text-white rounded-md hover:bg-red-600";const I=document.createTextNode(e.selectedNum+" conversation(s) selected"),j=document.createTextNode("Archive"),q=document.createTextNode("Delete");y.appendChild(I),h.appendChild(j),f.appendChild(q),w.appendChild(h),w.appendChild(f),a.appendChild(v),a.appendChild(y),a.appendChild(w),c.appendChild(a),u.before(c),e.extensionUI=c,e.isInjected=!0,f.addEventListener("click",async()=>{if(e.convList.length===0)return;const s=e.convList.filter(t=>t&&typeof t=="string"&&!t.includes("Promise"));if(s.length===0)return;f.disabled=!0,h.disabled=!0;const n=f.textContent;f.textContent="Deleting...";try{const t=await Promise.allSettled(s.map(o=>S("delete",o))),m=t.filter(o=>o.status==="fulfilled").length;if(t.filter(o=>o.status==="rejected").length>0){const o=t.filter(E=>E.status==="rejected").map(E=>E.reason?.message||"Unknown error");console.error("Failed deletes:",o)}e.convList=[],e.selectedNum=0,y.textContent="0 conversation(s) selected",setTimeout(()=>window.location.reload(),500)}catch(t){console.error("Delete operation failed:",t),alert("Operation failed. Check console for details."),f.disabled=!1,h.disabled=!1,f.textContent=n}}),h.addEventListener("click",async()=>{if(e.convList.length===0)return;const s=e.convList.filter(t=>t&&typeof t=="string"&&!t.includes("Promise"));if(s.length===0)return;h.disabled=!0,f.disabled=!0;const n=h.textContent;h.textContent="Archiving...";try{const t=await Promise.allSettled(s.map(o=>S("archive",o))),m=t.filter(o=>o.status==="fulfilled").length;if(t.filter(o=>o.status==="rejected").length>0){const o=t.filter(E=>E.status==="rejected").map(E=>E.reason?.message||"Unknown error");console.error("Failed archives:",o)}e.convList=[],e.selectedNum=0,y.textContent="0 conversation(s) selected",setTimeout(()=>window.location.reload(),500)}catch(t){console.error("Archive operation failed:",t),alert("Operation failed. Check console for details."),h.disabled=!1,f.disabled=!1,h.textContent=n}}),p.addEventListener("change",()=>{const s=l.querySelectorAll("nav a");e.toggleChecked=p.checked,p.checked?(v.style.display="flex",a.classList.remove("hidden"),d.classList.remove("bg-gray-300"),d.classList.remove("justify-start"),d.classList.add("bg-blue-500"),d.classList.add("justify-end"),a.classList.add("flex"),s.forEach(n=>{U(n)})):(v.style.display="none",L.checked=!1,e.checkAll=!1,a.classList.remove("flex"),a.classList.add("hidden"),d.classList.remove("justify-end"),a.classList.add("justify-start"),d.classList.add("bg-gray-300"),d.classList.remove("bg-blue-500")),s.forEach(n=>{P(n)}),e.convList=[],e.selectedNum=0,y.textContent="0 conversation(s) selected"}),L.addEventListener("change",()=>{if(!e.toggleChecked)return;e.checkAll=L.checked;const s=l.querySelectorAll("nav a");L.checked?(e.convList=[],s.forEach(n=>{const t=n.querySelector("input[type='checkbox']");if(t){t.checked=!0;const m=n.getAttribute("href"),x=N(m);x&&!e.convList.includes(x)&&e.convList.push(x)}})):(e.convList=[],s.forEach(n=>{const t=n.querySelector("input[type='checkbox']");t&&(t.checked=!1)})),e.selectedNum=e.convList.length,y.textContent=e.selectedNum+" conversation(s) selected"});function A(s){if(!e.toggleChecked)return;s.preventDefault();const n=s.currentTarget,t=n.querySelector("input[type='checkbox']");if(!t)return;t.checked=!t.checked;const m=n.getAttribute("href"),x=N(m);if(x){if(t.checked)e.convList.includes(x)||e.convList.push(x);else{const o=e.convList.indexOf(x);o>-1&&e.convList.splice(o,1)}e.selectedNum=e.convList.length,y.textContent=e.selectedNum+" conversation(s) selected"}}function U(s){if(s.querySelector("input[type='checkbox']"))return;const n=document.createElement("input");n.type="checkbox",n.name="conv",n.style.marginRight="8px",n.style.pointerEvents="none";const t=s.getAttribute("href"),m=N(t);e.checkAll&&m?(n.checked=!0,e.convList.includes(m)||e.convList.push(m)):m&&e.convList.includes(m)&&(n.checked=!0),s.prepend(n),s.addEventListener("click",A)}function P(s){const n=s.querySelector("input[type='checkbox']");n&&s.removeChild(n),s.removeEventListener("click",A)}}function R(u){const l=u.querySelectorAll("nav a"),c=document.querySelector("p.text-xs.text-gray-500");l.forEach(i=>{if(!i.querySelector("input[type='checkbox']")){const r=document.createElement("input");r.type="checkbox",r.name="conv",r.style.marginRight="8px";const b=i.getAttribute("href"),k=N(b);e.checkAll&&k?(r.checked=!0,e.convList.includes(k)||(e.convList.push(k),e.selectedNum=e.convList.length,c&&(c.textContent=e.selectedNum+" conversation(s) selected"))):k&&e.convList.includes(k)&&(r.checked=!0),i.prepend(r),i.addEventListener("click",p=>{if(!e.toggleChecked)return;p.preventDefault();const g=i.querySelector("input[type='checkbox']");if(!g)return;g.checked=!g.checked;const d=i.getAttribute("href"),C=N(d);if(!C)return;if(g.checked)e.convList.includes(C)||e.convList.push(C);else{const v=e.convList.indexOf(C);v>-1&&e.convList.splice(v,1)}e.selectedNum=e.convList.length;const a=document.querySelector("p.text-xs.text-gray-500");a&&(a.textContent=e.selectedNum+" conversation(s) selected")})}})}function N(u){if(!u||typeof u!="string")return null;const l=u.split("/"),c=l[l.length-1];return!c||c===""||c.includes("[object")||c.includes("Promise")||c==="undefined"||c==="null"?null:c}function S(u,l){return!l||typeof l!="string"?Promise.reject(new Error(`Invalid ID: ${l} (type: ${typeof l})`)):new Promise((c,i)=>{chrome.runtime.sendMessage({type:"GPT_HISTORY_ACTION",action:u,id:l},r=>{if(chrome.runtime.lastError){console.error("Extension error:",chrome.runtime.lastError),i(chrome.runtime.lastError);return}r&&r.success?c():(console.error(`${u} failed:`,r?r.error:"No response"),i(new Error(r?r.error:"Unknown error")))})})}
